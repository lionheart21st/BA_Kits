# 集团公司 综合成本分析

### 场景：AAA集团公司有三家工厂（电子厂A 和芯片厂A 都在苏州，机械厂A 在南京）

![1.png](https://i.loli.net/2021/05/05/EvkO6Lhiw2lUd3H.png)

![2.png](https://i.loli.net/2021/05/05/yxzhQNCiAT49wHu.png)

### 如上图1图2，三家工厂的数据都已近汇总到一个目录中，注意 其中苏州的数据在一个子目录（苏州报销项目）中

### 这里 模拟的 就是“汇总、提取 碎片化数据文件”：

* 在目标目录中，有各种各样的文件（word文档、Excel文档等），而且 不是所有的Excel文档 都是财务报销数据，只有“文件名中 包含 报销 关键字”的Excel文档才是！也就是说，在批量读取报销数据的同时 必须自动的过滤掉各种与当前任务无关的文件（即 排除干扰）！

* 财务报销文件 有多个，因为 报销这个动作 就是分批次的。而且，多个财务报销文件的所在路径不同 有的就在“source_data”之下，而有的在“source_data/苏州报销”之前（实际情况 目录可能还要更加复杂一些）。反正，同一个“根目录”中的财务报销文件都应该汇总处理（即 递归处理）！  
  


![3.png](https://i.loli.net/2021/05/05/TUo8jD9ZceNqrK4.png)
![4_1.png](https://i.loli.net/2021/05/05/AHMwCSge2FDZWn3.png)

### 如图3图4 仔细观察报表，发现：很多行 前三个字段（报销单号、报销日期、报销单位）都是空的。//姑且，称这些行 为“半空行”

### 原因是，这些报表都会财务系统中直接导出的 就有可能出现这种格式。其实，半空行 与其同组首行 都属于同一笔财务报销（前三个字段都相同）

### 问题在于，半空行 使得数据明显不符合第三范式的要求，因而无法有效的进行分组聚合计算！  

#### 特别注意点：仔细看 苏州的报销数据 与 南京的报销数据，对比可以发现 虽然字段名称都会一样的 但是字段顺序不同（这种情况在实际中，也是高概率发生）。代码必须能够应对这种情况！

</br>  

![5_1.png](https://i.loli.net/2021/05/05/PbDYowLXaysAckM.png)

### 如上图5，这是运行代码中的get_all_file_name()函数和fill_nan_line()函数的效果

### 可以看到：所有的报销数据都汇总到了一张表格中，而且“半空行”都被智能填充（以 同组首行的相应字段值填充）

### 此时，数据格式接近第三范式（因为 还有一些冗余，所以不是严格的第三范式）已经能够支持 接下来所要进行的分组聚合计算了！  
</br>  

![6_1.png](https://i.loli.net/2021/05/05/ZW6kO85cAIuN17y.png)

### 如上图6，代码的执行过程：可以看到 在绘制柱状图之前，都进行了分组聚合计算，即 将明细信息 按照所需要的维度、粒度 汇聚成总体信息  
</br>  

![Figure_1.png](https://i.loli.net/2021/05/05/QbK7n9W8d1Iy524.png)

### 如上图7，三家工程各自的总成本对比  
</br>  

![Figure_2.png](https://i.loli.net/2021/05/05/d4oKwnQqMPsgiEW.png)

### 如上图8，总成本按照科目划分的对比  
</br>  

![Figure_3.png](https://i.loli.net/2021/05/05/XoE1iG8JTAYd92v.png)

### 如图9，三家工厂的成本分别细分到各个科目 的对比  
</br>  
### 代码总共不超过200行，按照功能 划分了5个函数。较好的封装性，能够大大提高可复制性！

### 其中，single_bar()和multi_bar()是基于开源工具plt.bar()的二次开发。因为 提高了抽象层级和内聚性，所以变得更加高效易用！  
</br>  
### 另外，为了提高程序的健壮性，考虑到了这样的情况：

![10.png](https://i.loli.net/2021/05/05/4nrSchtTYCeDAJZ.png)

### 如上图10，现实情况中，有时候 或者有的工厂 报销科目并不是5个（因为 只花了3个科目的钱）。代码必须能够很好的应对这种情况！

### 将上图10中的Excel文件“苏州test项目2” 改名为"苏州报销项目2"，这样 该份数据（报销科目不全）就会被代码读入。  
</br>  

![Figure_4.png](https://i.loli.net/2021/05/05/5QGenm1EVrcCq2I.png)
![Figure_5.png](https://i.loli.net/2021/05/05/NTdbP3Um5Z64zMC.png)
![Figure_6.png](https://i.loli.net/2021/05/05/5DUvLRSIj2rZWOx.png)

### 对比上图中的数据 与 之前图片中的数据，可以看到数据是准确的 即代码运行正常！














